import os
import sys
import re
import logging
import ctypes
import time
import winshell
import json
import hashlib
from concurrent.futures import ThreadPoolExecutor, as_completed
from pathlib import Path
from logging.handlers import RotatingFileHandler
from send2trash import send2trash
from typing import Set, List, Tuple, Iterable, Optional, Dict

# ============= Rich å¢å¼ºå¼•å…¥ =============
from rich.console import Console
from rich.table import Table
from rich.progress import Progress, SpinnerColumn, TextColumn, BarColumn, TimeRemainingColumn
from rich.panel import Panel
from rich.text import Text
from rich import box
from rich.theme import Theme
from rich.columns import Columns
from rich.align import Align
from rich.style import Style
from rich.padding import Padding
from rich.rule import Rule
from rich.syntax import Syntax
from rich.markdown import Markdown

# è‡ªå®šä¹‰ä¸»é¢˜
custom_theme = Theme({
    "success": "bold green",
    "warning": "bold yellow",
    "error": "bold red",
    "info": "bold blue",
    "header": "bold white on dark_blue",
    "highlight": "bold cyan",
    "progress": "bold magenta",
    "path": "bright_white",
    "size": "bright_cyan"
})
console = Console(theme=custom_theme)

def print_header(title: str):
    """ç¾åŒ–æ ‡é¢˜è¾“å‡º"""
    console.print()
    console.print(Rule(title, style="header"), justify="center")
    console.print()

def print_section(title: str, content: str = ""):
    """ç¾åŒ–åˆ†åŒºè¾“å‡º"""
    console.print(Panel.fit(
        content,
        title=title,
        title_align="left",
        border_style="progress",
        padding=(1, 2)
    ))

def print_action(message: str, status: str = "info"):
    """ç¾åŒ–æ“ä½œçŠ¶æ€è¾“å‡º"""
    icons = {
        "info": "â„¹ï¸",
        "success": "âœ…",
        "warning": "âš ï¸",
        "error": "âŒ",
        "skip": "â©"
    }
    console.print(f"{icons.get(status, '')} [{status}]{message}[/]")

def print_file_action(path: Path, action: str, size_mb: float = 0):
    """ç¾åŒ–æ–‡ä»¶æ“ä½œè¾“å‡º"""
    actions = {
        "delete": ("[red]åˆ é™¤[/red]", "âŒ"),
        "skip": ("[yellow]è·³è¿‡[/yellow]", "â©"),
        "preview": ("[dim]é¢„è§ˆ[/dim]", "ğŸ‘ï¸"),
        "error": ("[red]é”™è¯¯[/red]", "â—")
    }
    style, icon = actions.get(action, ("", ""))
    size_info = f"[size]{size_mb:.1f} MB[/]" if size_mb > 0 else ""
    console.print(
        f"{icon} {style} {action.capitalize():<7} "
        f"[path]{str(path)}[/] {size_info}"
    )

def print_summary_table(title: str, data: List[Tuple[str, str]]):
    """ç¾åŒ–æ±‡æ€»è¡¨æ ¼è¾“å‡º"""
    table = Table(title=title, box=box.ROUNDED, show_header=False)
    table.add_column("Item", style="highlight", no_wrap=True)
    table.add_column("Value", style="info")
    for item, value in data:
        table.add_row(item, value)
    console.print(Padding(table, (1, 4)))

def print_progress_bar(description: str, total: int = None):
    """å¢å¼ºè¿›åº¦æ¡æ ·å¼"""
    return Progress(
        SpinnerColumn(),
        TextColumn("[progress.description]{task.description}"),
        BarColumn(complete_style="progress", finished_style="success"),
        TextColumn("[progress.percentage]{task.percentage:>3.0f}%"),
        TimeRemainingColumn(),
        console=console,
        expand=True
    )
# ======================================

# ================= é…ç½® =================
class Config:
    CONFIG_FILE = Path.home() / '.cleaner_config.json'
    
    # é»˜è®¤é…ç½®
    DEFAULT_CONFIG = {
        "WHITELIST_REGEX": r'(desktop\.ini|thumbs\.db|node_modules|\.git|\.?venv|env|'
                          r'(windows|winsxs|system32|boot|intel|amd|nvidia)[\\/]|'
                          r'system volume information|\$recycle\.bin|'
                          r'appdata|program files|perflogs|msocache)',
        "TEMP_EXTENSIONS": ['.tmp', '.temp', '.download', '.crdownload',
                           '.part', '.partial', '.dmp', '.log', '.bak'],
        "MAX_DIR_DEPTH": 20,
        "LOG_FILE": str(Path.home() / 'cleaner.log'),
        "LOG_MAX_SIZE": 5 * 1024 * 1024,
        "LOG_BACKUP_COUNT": 3,
        "SAFETY_FILE_SIZE_MB": 100,
        "SYSTEM_FILE_SIGNATURES": {
            "notepad.exe": "a8c8d6e7d48e284d85f2c79a3929bd53",
            "explorer.exe": "1e3d6e6f0e3e4e5d6e7f8e9d0e1e2e3e4"
        },
        "THREAD_POOL_SIZE": 4,
        "EXCLUDE_RECENT_FILES_HOURS": 1
    }
    
    def __init__(self):
        self.load_config()
        
    def load_config(self):
        """ä»é…ç½®æ–‡ä»¶åŠ è½½é…ç½®ï¼Œä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤é…ç½®"""
        try:
            if self.CONFIG_FILE.exists():
                with open(self.CONFIG_FILE, 'r', encoding='utf-8') as f:
                    user_config = json.load(f)
                    for key, value in user_config.items():
                        if key in self.DEFAULT_CONFIG:
                            self.DEFAULT_CONFIG[key] = value
        except Exception as e:
            logging.warning(f"åŠ è½½é…ç½®æ–‡ä»¶å¤±è´¥: {e}")
            
        # åˆå§‹åŒ–é…ç½®å±æ€§
        self.WHITELIST_REGEX = re.compile(self.DEFAULT_CONFIG["WHITELIST_REGEX"], re.IGNORECASE)
        self.TEMP_EXTENSIONS = set(self.DEFAULT_CONFIG["TEMP_EXTENSIONS"])
        self.MAX_DIR_DEPTH = self.DEFAULT_CONFIG["MAX_DIR_DEPTH"]
        self.LOG_FILE = Path(self.DEFAULT_CONFIG["LOG_FILE"])
        self.LOG_MAX_SIZE = self.DEFAULT_CONFIG["LOG_MAX_SIZE"]
        self.LOG_BACKUP_COUNT = self.DEFAULT_CONFIG["LOG_BACKUP_COUNT"]
        self.SAFETY_FILE_SIZE_MB = self.DEFAULT_CONFIG["SAFETY_FILE_SIZE_MB"]
        self.SYSTEM_FILE_SIGNATURES = self.DEFAULT_CONFIG["SYSTEM_FILE_SIGNATURES"]
        self.THREAD_POOL_SIZE = self.DEFAULT_CONFIG["THREAD_POOL_SIZE"]
        self.EXCLUDE_RECENT_FILES_HOURS = self.DEFAULT_CONFIG["EXCLUDE_RECENT_FILES_HOURS"]

config = Config()

# ============= æ—¥å¿—åˆå§‹åŒ– =============
def init_logging(quiet: bool = False):
    class SensitiveFilter(logging.Filter):
        def filter(self, record):
            if hasattr(record, 'msg'):
                record.msg = str(record.msg).replace(os.getenv('USERNAME', ''), '***')
            return True

    file_handler = RotatingFileHandler(
        config.LOG_FILE,
        maxBytes=config.LOG_MAX_SIZE,
        backupCount=config.LOG_BACKUP_COUNT,
        encoding='utf-8'
    )
    file_handler.addFilter(SensitiveFilter())
    file_handler.setFormatter(logging.Formatter('[%(asctime)s] %(levelname)s: %(message)s'))
    handlers = [file_handler]

    if not quiet:
        from rich.logging import RichHandler
        rh = RichHandler(console=console, show_path=False, rich_tracebacks=True)
        rh.addFilter(SensitiveFilter())
        handlers.append(rh)

    logging.basicConfig(level=logging.INFO, handlers=handlers)

# ============= å®‰å…¨å·¥å…·å‡½æ•° =============
def is_admin() -> bool:
    try:
        return ctypes.windll.shell32.IsUserAnAdmin()
    except:
        return False

def require_admin():
    if not is_admin():
        print_header("æƒé™è­¦å‘Š")
        print_section("éœ€è¦ç®¡ç†å‘˜æƒé™", "æ­¤æ“ä½œéœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½ç»§ç»­")
        params = " ".join(f'"{arg}"' for arg in sys.argv)
        if ctypes.windll.shell32.ShellExecuteW(None, "runas", sys.executable, params, None, 1) <= 32:
            print_action("æƒé™æå‡å¤±è´¥", "error")
        sys.exit(1)

def is_safe_path(path: Path) -> bool:
    """æ£€æŸ¥è·¯å¾„æ˜¯å¦å®‰å…¨ï¼ˆé˜²æ­¢è·¯å¾„éå†ï¼‰"""
    try:
        path.resolve().relative_to(Path.cwd())
        return True
    except ValueError:
        return False

def is_whitelisted(path: Path) -> bool:
    """æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨ç™½åå•ä¸­"""
    if not is_safe_path(path):
        return True
    return bool(config.WHITELIST_REGEX.search(str(path)))

def is_system_file(path: Path) -> bool:
    """æ£€æŸ¥æ˜¯å¦æ˜¯å—ä¿æŠ¤çš„ç³»ç»Ÿæ–‡ä»¶"""
    if not path.is_file():
        return False
        
    try:
        file_name = path.name.lower()
        if file_name in config.SYSTEM_FILE_SIGNATURES:
            with open(path, 'rb') as f:
                file_hash = hashlib.md5(f.read()).hexdigest()
            return file_hash == config.SYSTEM_FILE_SIGNATURES[file_name]
        return False
    except Exception:
        logging.exception(f"ç³»ç»Ÿæ–‡ä»¶æ£€æŸ¥å¼‚å¸¸: {path}")
        return True

def is_hardlink(path: Path) -> bool:
    """æ£€æŸ¥æ˜¯å¦æ˜¯ç¡¬é“¾æ¥"""
    try:
        return path.is_file() and path.stat().st_nlink > 1
    except Exception:
        logging.exception(f"ç¡¬é“¾æ¥æ£€æŸ¥å¼‚å¸¸: {path}")
        return False

def is_resource_in_use(path: Path) -> bool:
    """æ£€æŸ¥èµ„æºæ˜¯å¦è¢«å ç”¨"""
    try:
        if not is_safe_path(path):
            return True
            
        if path.is_file():
            try:
                fd = os.open(path, os.O_RDWR | os.O_EXCL | os.O_NOINHERIT)
                os.close(fd)
                return False
            except OSError:
                return True
        elif path.is_dir():
            test_file = path / f".test_{os.getpid()}"
            try:
                test_file.touch(exist_ok=False)
                test_file.unlink()
                return False
            except:
                return True
        return False
    except Exception:
        logging.exception(f"èµ„æºæ£€æŸ¥å¼‚å¸¸: {path}")
        return True

def calculate_size(path: Path) -> int:
    """é«˜æ•ˆè®¡ç®—æ–‡ä»¶æˆ–ç›®å½•å¤§å°ï¼ˆå¤šçº¿ç¨‹ä¼˜åŒ–ï¼‰"""
    if not is_safe_path(path):
        return 0
        
    if path.is_file():
        return path.stat().st_size if not is_hardlink(path) else 0
        
    total = 0
    with ThreadPoolExecutor(max_workers=config.THREAD_POOL_SIZE) as executor:
        futures = []
        for root, _, files in os.walk(path):
            for file in files:
                file_path = Path(root) / file
                futures.append(executor.submit(
                    lambda p: p.stat().st_size if p.is_file() and not is_hardlink(p) else 0,
                    file_path
                ))
        
        for future in as_completed(futures):
            total += future.result()
            
    return total

def confirm_large_file(path: Path, size_mb: float) -> bool:
    """å¤§æ–‡ä»¶äºŒæ¬¡ç¡®è®¤"""
    if size_mb < config.SAFETY_FILE_SIZE_MB:
        return True
    
    print_header("å¤§æ–‡ä»¶è­¦å‘Š")
    print_section(
        "æ£€æµ‹åˆ°å¤§æ–‡ä»¶",
        f"è·¯å¾„: [path]{path}[/]\nå¤§å°: [size]{size_mb:.1f} MB[/]"
    )
    confirm = console.input('[bold red]âš ï¸  ç¡®è®¤åˆ é™¤æ­¤å¤§æ–‡ä»¶? (y/n): [/]')
    return confirm.lower() == 'y'

# ============= å®‰å…¨åˆ é™¤ =============
def safe_delete(path: Path, preview: bool = True) -> Tuple[bool, int]:
    try:
        # å®‰å…¨æ£€æŸ¥
        if not is_safe_path(path):
            print_file_action(path, "skip")
            return False, 0
            
        if is_whitelisted(path):
            print_file_action(path, "skip")
            return False, 0
            
        if is_system_file(path):
            print_file_action(path, "skip")
            return False, 0
            
        if path.is_symlink() or is_hardlink(path):
            print_file_action(path, "skip")
            return False, 0
            
        if path.is_dir():
            dir_depth = len(str(path.resolve()).split(os.sep))
            if dir_depth > config.MAX_DIR_DEPTH:
                print_file_action(path, "skip")
                return False, 0
                
        if is_resource_in_use(path):
            print_file_action(path, "skip")
            return False, 0

        # è®¡ç®—å¤§å°
        size = calculate_size(path)
        size_mb = size / 1024 / 1024
        
        if preview:
            print_file_action(path, "preview", size_mb)
            return False, 0
            
        # å¤§æ–‡ä»¶äºŒæ¬¡ç¡®è®¤
        if size_mb >= config.SAFETY_FILE_SIZE_MB:
            if not confirm_large_file(path, size_mb):
                print_file_action(path, "skip")
                return False, 0
                
        # æ‰§è¡Œåˆ é™¤
        send2trash(path)
        print_file_action(path, "delete", size_mb)
        return True, size
    except Exception as e:
        print_file_action(path, "error")
        logging.exception(f"åˆ é™¤å¤±è´¥: {path}")
        return False, 0

# ============= æ¸…ç†åŠŸèƒ½ =============
def get_system_temp_dirs() -> List[Path]:
    """è·å–ç³»ç»Ÿä¸´æ—¶ç›®å½•ï¼ˆå¢å¼ºå®‰å…¨æ€§ï¼‰"""
    temp_dirs = set()
    env_vars = ['TEMP', 'TMP', 'LOCALAPPDATA']
    
    for var in env_vars:
        if path_str := os.environ.get(var):
            try:
                path = Path(path_str).resolve()
                if path.exists() and os.access(path, os.R_OK | os.W_OK) and is_safe_path(path):
                    temp_dirs.add(path)
            except Exception:
                continue
                
    system_dirs = [
        Path(os.environ.get('SystemRoot', 'C:/Windows')) / 'Temp',
        Path('C:/Windows/Temp'),
        Path('C:/Windows/Logs'),
        Path('C:/Windows/Prefetch'),
    ]
    
    for dir_path in system_dirs:
        try:
            resolved = dir_path.resolve()
            if resolved.exists() and os.access(resolved, os.R_OK) and is_safe_path(resolved):
                temp_dirs.add(resolved)
        except Exception:
            continue
            
    return sorted(temp_dirs, key=lambda x: len(str(x)), reverse=True)

def clean_temp(preview: bool = True) -> int:
    """æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆç¾åŒ–è¾“å‡ºï¼‰"""
    print_header("æ¸…ç†ä¸´æ—¶æ–‡ä»¶")
    temp_dirs = get_system_temp_dirs()
    
    if not temp_dirs:
        print_action("æœªæ‰¾åˆ°å¯æ¸…ç†çš„ä¸´æ—¶ç›®å½•", "warning")
        return 0
    
    print_section("æ‰«æç›®å½•", "\n".join(f"â€¢ [path]{d}[/]" for d in temp_dirs))
    
    total_size = 0
    with print_progress_bar("æ‰«æä¸´æ—¶æ–‡ä»¶...") as progress:
        task = progress.add_task("æ¸…ç†ä¸­...", total=len(temp_dirs))
        for temp_dir in temp_dirs:
            if temp_dir.exists():
                for item in temp_dir.iterdir():
                    # è·³è¿‡æœ€è¿‘åˆ›å»ºçš„æ–‡ä»¶
                    recent_threshold = time.time() - config.EXCLUDE_RECENT_FILES_HOURS * 3600
                    if (item.is_file() or item.is_dir()) and item.stat().st_ctime > recent_threshold:
                        continue
                        
                    ok, size = safe_delete(item, preview)
                    if ok:
                        total_size += size
            progress.advance(task)
    
    size_mb = total_size / 1024 / 1024
    print_summary_table("ä¸´æ—¶æ–‡ä»¶æ¸…ç†ç»“æœ", [
        ("æ‰«æç›®å½•æ•°", str(len(temp_dirs))),
        ("é‡Šæ”¾ç©ºé—´", f"{size_mb:.2f} MB"),
        ("æ¨¡å¼", "é¢„è§ˆ" if preview else "å®é™…æ‰§è¡Œ")
    ])
    return total_size

def clean_browser_cache(preview: bool = True) -> int:
    """æ¸…ç†æµè§ˆå™¨ç¼“å­˜ï¼ˆç¾åŒ–è¾“å‡ºï¼‰"""
    print_header("æ¸…ç†æµè§ˆå™¨ç¼“å­˜")
    browsers = {
        "Chrome": Path(os.environ.get('LOCALAPPDATA', '')) / 'Google' / 'Chrome' / 'User Data' / 'Default' / 'Cache',
        "Edge": Path(os.environ.get('LOCALAPPDATA', '')) / 'Microsoft' / 'Edge' / 'User Data' / 'Default' / 'Cache',
        "Firefox": Path(os.environ.get('LOCALAPPDATA', '')) / 'Mozilla' / 'Firefox' / 'Profiles'
    }
    
    valid_browsers = {}
    for name, path in browsers.items():
        if path.exists():
            valid_browsers[name] = path
    
    if not valid_browsers:
        print_action("æœªæ‰¾åˆ°æµè§ˆå™¨ç¼“å­˜ç›®å½•", "warning")
        return 0
    
    print_section("æ£€æµ‹åˆ°çš„æµè§ˆå™¨", "\n".join(
        f"â€¢ {name}: [path]{path}[/]" for name, path in valid_browsers.items()
    ))
    
    total_size = 0
    with print_progress_bar("æ‰«ææµè§ˆå™¨ç¼“å­˜...") as progress:
        task = progress.add_task("æ¸…ç†ä¸­...", total=len(valid_browsers))
        for name, cache_dir in valid_browsers.items():
            if cache_dir.exists():
                for item in cache_dir.iterdir():
                    ok, size = safe_delete(item, preview)
                    if ok:
                        total_size += size
            progress.advance(task)
    
    size_mb = total_size / 1024 / 1024
    print_summary_table("æµè§ˆå™¨ç¼“å­˜æ¸…ç†ç»“æœ", [
        ("æµè§ˆå™¨æ•°é‡", str(len(valid_browsers))),
        ("é‡Šæ”¾ç©ºé—´", f"{size_mb:.2f} MB"),
        ("æ¨¡å¼", "é¢„è§ˆ" if preview else "å®é™…æ‰§è¡Œ")
    ])
    return total_size

def clean_recycle_bin(preview: bool = True) -> int:
    """æ¸…ç©ºå›æ”¶ç«™ï¼ˆç¾åŒ–è¾“å‡ºï¼‰"""
    print_header("æ¸…ç†å›æ”¶ç«™")
    
    if preview:
        print_action("é¢„è§ˆæ¨¡å¼è·³è¿‡å›æ”¶ç«™æ¸…ç†", "info")
        return 0
    
    try:
        print_action("æ­£åœ¨æ¸…ç©ºå›æ”¶ç«™...", "info")
        winshell.recycle_bin().empty(confirm=False, show_progress=False, sound=False)
        print_action("å›æ”¶ç«™å·²æ¸…ç©º", "success")
        return 0  # æ— æ³•è®¡ç®—å›æ”¶ç«™å¤§å°
    except Exception as e:
        print_action(f"æ¸…ç©ºå›æ”¶ç«™å¤±è´¥: {e}", "error")
        return 0

def clean_downloads(preview: bool = True) -> int:
    """æ¸…ç†ä¸‹è½½ç›®å½•ï¼ˆç¾åŒ–è¾“å‡ºï¼‰"""
    print_header("æ¸…ç†ä¸‹è½½ç›®å½•")
    downloads_dir = Path.home() / 'Downloads'
    
    if not downloads_dir.exists():
        print_action("ä¸‹è½½ç›®å½•ä¸å­˜åœ¨", "warning")
        return 0
    
    print_section("æ‰«æç›®å½•", f"[path]{downloads_dir}[/]")
    
    total_size = 0
    count = 0
    with print_progress_bar("æ‰«æä¸‹è½½æ–‡ä»¶...") as progress:
        task = progress.add_task("æ¸…ç†ä¸­...", total=None)
        for item in downloads_dir.iterdir():
            if item.suffix.lower() in config.TEMP_EXTENSIONS:
                ok, size = safe_delete(item, preview)
                if ok:
                    total_size += size
                    count += 1
            progress.advance(task)
    
    size_mb = total_size / 1024 / 1024
    print_summary_table("ä¸‹è½½ç›®å½•æ¸…ç†ç»“æœ", [
        ("åˆ é™¤æ–‡ä»¶æ•°", str(count)),
        ("é‡Šæ”¾ç©ºé—´", f"{size_mb:.2f} MB"),
        ("æ¨¡å¼", "é¢„è§ˆ" if preview else "å®é™…æ‰§è¡Œ")
    ])
    return total_size

def main(preview: bool = True, quiet: bool = False):
    """ä¸»å‡½æ•°ï¼ˆç¾åŒ–è¾“å‡ºï¼‰"""
    print_header("Windows åƒåœ¾æ¸…ç†å·¥å…·")
    start_time = time.time()

    if not preview and not is_admin():
        require_admin()

    if not preview:
        if not quiet:
            print_section("è­¦å‘Š", "å³å°†å®é™…åˆ é™¤æ–‡ä»¶ï¼Œè¯·ç¡®è®¤!")
            confirm = console.input('[bold red]âš ï¸  ç¡®è®¤å®é™…åˆ é™¤æ–‡ä»¶? (y/n): [/]')
            if confirm.lower() != 'y':
                print_action("æ“ä½œå·²å–æ¶ˆ", "warning")
                return

    total_size = 0
    total_size += clean_temp(preview)
    total_size += clean_browser_cache(preview)
    total_size += clean_recycle_bin(preview)
    total_size += clean_downloads(preview)

    elapsed = time.time() - start_time
    size_mb = total_size / 1024 / 1024
    size_gb = size_mb / 1024
    
    # ç¾åŒ–ç»“æœå±•ç¤º
    print_header("æ¸…ç†å®Œæˆ")
    print_summary_table("æœ€ç»ˆæ¸…ç†ç»“æœ", [
        ("é‡Šæ”¾æ€»ç©ºé—´", f"{size_mb:.2f} MB ({size_gb:.2f} GB)"),
        ("æ€»è€—æ—¶", f"{elapsed:.2f} ç§’"),
        ("æ‰§è¡Œæ¨¡å¼", "å®é™…æ‰§è¡Œ" if not preview else "é¢„è§ˆ")
    ])
    
    # ä¿å­˜é…ç½®é€‰é¡¹
    if not quiet and console.input('[bold]æ˜¯å¦ä¿å­˜å½“å‰é…ç½®? (y/n): [/]').lower() == 'y':
        try:
            with open(config.CONFIG_FILE, 'w', encoding='utf-8') as f:
                json.dump(config.DEFAULT_CONFIG, f, indent=4)
            print_action(f"é…ç½®å·²ä¿å­˜åˆ°: {config.CONFIG_FILE}", "success")
        except Exception as e:
            print_action(f"ä¿å­˜é…ç½®å¤±è´¥: {e}", "error")

if __name__ == '__main__':
    import argparse
    parser = argparse.ArgumentParser(description='Windows åƒåœ¾æ¸…ç†å·¥å…· ')
    parser.add_argument('--run', action='store_true', help='çœŸæ­£æ‰§è¡Œæ¸…ç†ï¼ˆé»˜è®¤ä»…é¢„è§ˆï¼‰')
    parser.add_argument('--debug', action='store_true', help='å¯ç”¨è°ƒè¯•æ—¥å¿—')
    parser.add_argument('--quiet', action='store_true', help='é™é»˜æ¨¡å¼ï¼ˆæ— ç»ˆç«¯è¾“å‡ºï¼Œåªå†™æ—¥å¿—ï¼‰')
    args = parser.parse_args()

    init_logging(quiet=args.quiet)
    if args.debug:
        logging.getLogger().setLevel(logging.DEBUG)

    if not args.run and not args.quiet:
        print_section("ä¿¡æ¯", "è¿è¡Œåœ¨é¢„è§ˆæ¨¡å¼ï¼ˆä¸ä¼šå®é™…åˆ é™¤æ–‡ä»¶ï¼‰")
        print_action("ä½¿ç”¨ --run å‚æ•°æ‰§è¡Œå®é™…åˆ é™¤æ“ä½œ", "info")

    try:
        main(preview=not args.run, quiet=args.quiet)
    except KeyboardInterrupt:
        print_action("æ“ä½œå·²å–æ¶ˆ", "warning")
        sys.exit(0)
    except Exception as e:
        console.print_exception()
        sys.exit(1)
